<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vote – DÉMOS</title>
<style>
  :root{ --bg:#0b1020; --muted:#9aa7c7; --border:rgba(255,255,255,.14); --accent:#4fd1c5; }
  body{ margin:0; padding:18px; background:var(--bg); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .card{ max-width:720px; margin:0 auto; border:1px solid var(--border); border-radius:16px; padding:16px; background:rgba(255,255,255,.04); }
  .meta{ color:var(--muted); font-size:13px; display:flex; gap:10px; flex-wrap:wrap; }
  h1{ margin:12px 0 14px; font-size:22px; line-height:1.25; }
  .opt{ width:100%; text-align:left; padding:14px; border-radius:12px; border:1px solid var(--border);
        background:rgba(255,255,255,.06); color:#fff; font-weight:800; cursor:pointer; }
  .opt:disabled{ opacity:.55; cursor:not-allowed; }
  .ok{ margin-top:14px; padding:12px; border-radius:12px; border:1px solid rgba(79,209,197,.35); background:rgba(79,209,197,.12); display:none; }
  .err{ margin-top:14px; padding:12px; border-radius:12px; border:1px solid rgba(255,107,107,.35); background:rgba(255,107,107,.12); display:none; white-space:pre-wrap; }
  a{ color:var(--accent); text-decoration:none; } a:hover{ text-decoration:underline; }
  /* === RESULTATS LIVE === */
#liveResults{
  margin-top:12px;
  border:1px solid rgba(79,209,197,.35);
  background: rgba(79,209,197,.08);
  padding:12px;
  border-radius:14px;
}
.lr-item{ margin:10px 0; }
.lr-top{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-weight:800;
}
.lr-bar{
  margin-top:6px;
  height:10px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  overflow:hidden;
}
.lr-fill{
  height:100%;
  width:0%;
  background:rgba(79,209,197,.75);
}
.lr-small{
  color:rgba(255,255,255,.75);
  font-size:12px;
  margin-top:10px;
}

</style>
</head>

<body>
  <div class="card">
    <div class="meta">
      <span>DÉMOS</span>
      <span>•</span>
      <span>Vote <span id="voteLabel">?</span></span>
    </div>

    <h1 id="title">Chargement…</h1>
    <div id="options" style="display:grid; gap:12px;"></div>

    <div class="ok" id="okBox"></div>
    <div class="ok" id="liveResults" style="display:none;"></div>
    <div class="err" id="errBox"></div>
  </div>

<script>
(function(){
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfHhgAvrqguR88WYrYNmbMcVeHikMl_c2RFJr-jLfhOhFGsW3nsISAuo7kGKCSYXtp/exec";

  const $ = (id) => document.getElementById(id);
  const url = new URL(location.href);

  const m = String(url.searchParams.get("vote") || "1").match(/(\d+)/);
  const vote = m ? parseInt(m[1], 10) : 1;

  $("voteLabel").textContent = String(vote);

  const title = $("title");
  const options = $("options");
  const okBox = $("okBox");
  const errBox = $("errBox");
// === RESULTATS LIVE (lecture seule) ===
const RESULTS_REFRESH_MS = 10000; // 10 secondes
let resultsTimer = null;

function renderLiveResults(counts, poll){
  const letters = poll.options.map((_, i) => String.fromCharCode(65 + i));
  const total = letters.reduce((s,k)=>s + (counts[k] || 0), 0);

  let html = `<div style="font-weight:900;margin-bottom:6px;">Résultats en direct</div>`;

  letters.forEach((k, idx) => {
    const label = poll.options[idx];
    const n = counts[k] || 0;
    const pct = total ? Math.round((n / total) * 100) : 0;

    html += `
      <div class="lr-item">
        <div class="lr-top">
          <div>${label}</div>
          <div>${n} • ${pct}%</div>
        </div>
        <div class="lr-bar">
          <div class="lr-fill" style="width:${pct}%"></div>
        </div>
      </div>
    `;
  });

  html += `<div class="lr-small">Total votes : ${total}</div>`;
  document.getElementById("liveResults").innerHTML = html;
}

async function fetchResults(){
  const res = await fetch(`${SCRIPT_URL}?vote=${encodeURIComponent(vote)}`, { cache: "no-store" });
  const txt = await res.text();
  let data = null;
  try { data = JSON.parse(txt); } catch(e) {}
  if(data && data.status === "ok" && data.counts){
    renderLiveResults(data.counts, poll);
  }
}

function startLiveResults(){
  const box = document.getElementById("liveResults");
  box.style.display = "block";
  fetchResults();
  if(resultsTimer) clearInterval(resultsTimer);
  resultsTimer = setInterval(fetchResults, RESULTS_REFRESH_MS);
}

  
  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }

  // ✅ Charge polls.js de façon NON BLOQUANTE
  function loadPolls(cb){
    const s = document.createElement("script");
    s.src = "./polls.js?v=" + Date.now(); // anti-cache
    s.onload = () => cb(null);
    s.onerror = () => cb(new Error("Impossible de charger polls.js"));
    document.head.appendChild(s);
  }

  function render(){
    const polls = window.POLLS || {};
    const poll = polls[vote];

    if(!poll){
      title.textContent = "Question introuvable";
      showErr("La question n’a pas été trouvée dans polls.js (window.POLLS[" + vote + "]).");
      return;
    }

    title.textContent = poll.title;
    options.innerHTML = "";

    poll.options.forEach((txt, i) => {
      const letter = String.fromCharCode(65 + i); // A,B,C...
      const b = document.createElement("button");
      b.className = "opt";
      b.textContent = txt;
      b.onclick = () => send(letter);
      options.appendChild(b);
    });
  }

  function disableAll(disabled){
    [...document.querySelectorAll(".opt")].forEach(b => b.disabled = disabled);
  }

  async function send(choiceLetter){
    okBox.style.display = "none";
    errBox.style.display = "none";
    disableAll(true);

    try{
      // doPost attend vote/choice en paramètres (et/ou JSON). Ici on le fait simple.
      const endpoint = `${SCRIPT_URL}?vote=${encodeURIComponent(vote)}&choice=${encodeURIComponent(choiceLetter)}`;
      const res = await fetch(endpoint, { method: "POST" });
const txt = await res.text();

let data = null;
try { data = JSON.parse(txt); } catch(e) {}

if(!data){
  throw new Error("Réponse non-JSON du serveur :\n" + txt.slice(0, 300));
}


      if(data.status === "ok"){
        okBox.style.display = "block";
        okBox.textContent = "✅ Merci ! Votre vote a été pris en compte.";
        startLiveResults();   // ← ICI, avant le return
        return;
      }

      showErr("Erreur serveur :\n" + JSON.stringify(data, null, 2));
      disableAll(false);
    }catch(e){
      showErr("Erreur réseau : " + e);
      disableAll(false);
    }
  }

  // Démarrage
  title.textContent = "Chargement de la question…";
  loadPolls((err) => {
    if(err){
      title.textContent = "Erreur";
      showErr(err.message + "\n\nVérifie que polls.js existe bien à la racine du dépôt (même dossier que question.html).");
      return;
    }
    render();
  });
})();
</script>
</body>
</html>





