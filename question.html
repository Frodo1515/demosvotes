<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vote</title>
  <style>
    :root{ --bg:#0b1020; --card:#121a33; --muted:#9aa7c7; --text:#fff; --border:rgba(255,255,255,.12); --accent:#4fd1c5; }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(900px 600px at 20% 10%, rgba(79,209,197,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(154,167,199,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }
    .card{
      max-width:720px; margin:0 auto;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    .meta{ color:var(--muted); font-size:13px; display:flex; gap:10px; flex-wrap:wrap; }
    .pill{ border:1px solid var(--border); background:rgba(255,255,255,.05); padding:6px 10px; border-radius:999px; }
    h1{ margin:12px 0 0; font-size:22px; line-height:1.25; }
    .opts{ display:grid; gap:12px; margin-top:16px; }
    button.opt{
      width:100%;
      text-align:left;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    button.opt:disabled{ opacity:.6; cursor:not-allowed; }
    .ok{
      margin-top:14px;
      border:1px solid rgba(79,209,197,.35);
      background: rgba(79,209,197,.12);
      padding:12px;
      border-radius:14px;
      display:none;
      white-space:pre-wrap;
    }
    .err{
      margin-top:14px;
      border:1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.12);
      padding:12px;
      border-radius:14px;
      display:none;
      white-space:pre-wrap;
    }
    .small{ margin-top:10px; color:var(--muted); font-size:12px; }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="card">
    <div class="meta">
      <span class="pill">DÉMOS</span>
      <span class="pill">Vote <span id="voteLabel">?</span></span>
    </div>

    <h1 id="qTitle">Chargement…</h1>
    <div class="opts" id="opts"></div>

    <div class="ok" id="okBox"></div>
    <div class="ok" id="liveResults" style="display:none;"></div>
    <div class="err" id="errBox"></div>

    <div class="small" id="lockInfo"></div>
  </div>

  <script src="./polls.js"></script>
  <script>
    (function(){
      // ✅ URL Apps Script (POST)
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfHhgAvrqguR88WYrYNmbMcVeHikMl_c2RFJr-jLfhOhFGsW3nsISAuo7kGKCSYXtp/exec";

      const $ = (id) => document.getElementById(id);
      const url = new URL(location.href);

      function parseVote(){
        // accepte ?vote=1 ou ?vote=Vote1 etc.
        const raw = String(url.searchParams.get("vote") || "1");
        const m = raw.match(/(\d+)/);
        const n = m ? parseInt(m[1], 10) : 1;
        return (n>=1 && n<=8) ? n : 1;
      }

      const vote = parseVote();
      $("voteLabel").textContent = vote;

      const poll = (window.POLLS || {})[vote];
      if(!poll){
        $("qTitle").textContent = "Question introuvable.";
        $("errBox").style.display = "block";
        $("errBox").textContent = `Aucune question pour vote=${vote} dans polls.js`;
        return;
      }

      $("qTitle").textContent = poll.title;
      const opts = $("opts");
      opts.innerHTML = "";

      // Anti double-vote simple (localStorage) : 1 vote max par téléphone par question
      const lockKey = `DEMOS_VOTE_LOCK_${vote}`;
      const locked = localStorage.getItem(lockKey) === "1";
      if(locked){
        $("lockInfo").textContent = "Vous avez déjà voté pour cette question sur ce téléphone.";
      }

      function setAllDisabled(disabled){
        [...document.querySelectorAll("button.opt")].forEach(b => b.disabled = disabled);
      }

      async function send(choiceLetter){
        $("okBox").style.display = "none";
        $("errBox").style.display = "none";

        setAllDisabled(true);

        try{
          const endpoint = `${SCRIPT_URL}?vote=${encodeURIComponent(vote)}&choice=${encodeURIComponent(choiceLetter)}`;
          const res = await fetch(endpoint, { method: "POST" });
          const txt = await res.text();

          // Essaye JSON, sinon affiche texte brut
          let data = null;
          try { data = JSON.parse(txt); } catch(e){}

          if(data && data.status === "ok"){
            localStorage.setItem(lockKey, "1");
            $("lockInfo").textContent = "Vote enregistré. Merci !";
            $("okBox").style.display = "block";
            $("okBox").textContent = `✅ Merci ! Votre vote (${choiceLetter}) a été pris en compte.`;
            return;
          }

          $("errBox").style.display = "block";
          $("errBox").textContent = "Erreur renvoyée par le serveur:\n" + (data ? JSON.stringify(data, null, 2) : txt);

          setAllDisabled(false);
        }catch(err){
          $("errBox").style.display = "block";
          $("errBox").textContent = "Erreur réseau:\n" + err;
          setAllDisabled(false);
        }
      }

      // Crée les boutons A.. selon le nombre d'options (4 ou 5)
      poll.options.forEach((label, idx) => {
        const letter = String.fromCharCode(65 + idx); // A,B,C...
        const btn = document.createElement("button");
        btn.className = "opt";
        btn.textContent = label;
        btn.disabled = locked;
        btn.addEventListener("click", () => send(letter));
        opts.appendChild(btn);
      });

      if(locked){
        setAllDisabled(true);
      }
    })();
  </script>
</body>
</html>

