<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RÃ©sultats â€“ DÃ‰MOS</title>
  <style>
    :root{
      --bg:#0b1020; --text:#fff; --muted:#9aa7c7; --border:rgba(255,255,255,.12);
      --card:rgba(255,255,255,.04); --accent:rgba(79,209,197,.75); --danger:rgba(255,107,107,.85);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:18px 22px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .title{ font-size:20px; font-weight:900; }
    .meta{ color:var(--muted); font-size:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ border:1px solid var(--border); background:rgba(255,255,255,.05); padding:6px 10px; border-radius:999px; }
    main{ padding:22px; }
    .card{ max-width:980px; margin:0 auto; background:var(--card); border:1px solid var(--border); border-radius:18px; padding:18px; }
    h1{ margin:0 0 14px; font-size:26px; line-height:1.2; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 0; }
    button{
      border:1px solid var(--border); background:rgba(255,255,255,.06); color:var(--text);
      padding:10px 14px; border-radius:14px; font-weight:900; cursor:pointer; font-size:14px;
    }
    button:hover{ background:rgba(255,255,255,.10); }
    .grid{ display:grid; gap:12px; margin-top:16px; }
    .item{ border:1px solid var(--border); background:rgba(255,255,255,.04); border-radius:14px; padding:12px; }
    .top{ display:flex; justify-content:space-between; gap:12px; align-items:center; font-weight:900; }
    .count{ color:var(--muted); font-weight:800; }
    .bar{ margin-top:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.10); overflow:hidden; }
    .fill{ height:100%; width:0%; background:var(--accent); }
    .hint{ margin-top:12px; color:var(--muted); font-size:13px; }
    .error{
      display:none; margin-top:12px; white-space:pre-wrap;
      color:#ffd1d1; background:rgba(255,107,107,.12); border:1px solid rgba(255,107,107,.35);
      padding:10px 12px; border-radius:14px;
    }
    code{ color:#cfe8ff; }
  </style>
</head>
<body>

<header>
  <div>
    <div class="title">DÃ‰MOS â€“ RÃ©sultats</div>
    <div class="meta">
      <span class="pill">Vote : <span id="voteLabel">?</span></span>
      <span class="pill">Auto refresh : <span id="autoLabel">OFF</span></span>
      <span class="pill">Endpoint testÃ© : <span id="endpointLabel">â€”</span></span>
    </div>
  </div>
  <div class="row">
    <button id="refreshBtn">RafraÃ®chir</button>
    <button id="toggleAutoBtn">Auto (5s)</button>
    <button id="backBtn">Retour Vote</button>
  </div>
</header>

<main>
  <div class="card">
    <h1 id="qTitle">Chargementâ€¦</h1>
    <div id="grid" class="grid"></div>
    <div id="errBox" class="error"></div>
    <div id="hint" class="hint"></div>
  </div>
</main>

<script src="./polls.js"></script>
<script>
(() => {
  // âœ… TON Apps Script
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfHhgAvrqguR88WYrYNmbMcVeHikMl_c2RFJr-jLfhOhFGsW3nsISAuo7kGKCSYXtp/exec";

  const $ = (id) => document.getElementById(id);
  const grid = $("grid");
  const errBox = $("errBox");

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function hideError(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function parseVote(){
    const u = new URL(location.href);
    const m = String(u.searchParams.get("vote") || "1").match(/(\d+)/);
    const n = m ? parseInt(m[1], 10) : 1;
    return (n>=1 && n<=8) ? n : 1;
  }

  function normalizeCounts(data){
    // TolÃ¨re plein de formats : {A:..} / {counts:{A:..}} / {results:{A:..}} / {data:{A:..}}
    const obj = data?.counts || data?.results || data?.data || data;
    const out = {};
    ["A","B","C","D","E"].forEach(k => {
      const v = obj?.[k];
      out[k] = (typeof v === "number") ? v : (parseInt(v || "0", 10) || 0);
    });
    return out;
  }

  function render(poll, counts){
    $("qTitle").textContent = poll?.title || "RÃ©sultats";
    grid.innerHTML = "";

    const letters = poll.options.map((_, i) => String.fromCharCode(65+i)); // A,B,C,(D,E)
    const total = letters.reduce((s,k)=> s + (counts[k]||0), 0);

    letters.forEach((k, idx) => {
      const label = poll.options[idx] || k;
      const n = counts[k] || 0;
      const pct = total ? Math.round((n/total)*100) : 0;

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="top">
          <div>${label}</div>
          <div class="count">${n} â€¢ ${pct}%</div>
        </div>
        <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
      `;
      grid.appendChild(item);
    });

    $("hint").textContent = total
      ? `Total votes : ${total}`
      : `Aucun vote enregistrÃ© (ou lâ€™API ne renvoie pas encore les comptes).`;
  }

  async function fetchAsJson(url){
    const res = await fetch(url, { cache: "no-store" });
    const text = await res.text();

    // 1) JSON direct
    try { return JSON.parse(text); } catch(e) {}

    // 2) JSONP : callbackName({...})
    const jsonp = text.match(/^[\w$]+\((.*)\)\s*;?\s*$/s);
    if (jsonp){
      try { return JSON.parse(jsonp[1]); } catch(e) {}
    }

    // sinon -> erreur avec preview
    throw new Error("RÃ©ponse non-JSON. DÃ©but:\n" + text.slice(0, 500));
  }

  function buildCandidates(vote){
    // On tente plusieurs conventions frÃ©quentes
    const base = new URL(SCRIPT_URL);

    const make = (params) => {
      const u = new URL(base.toString());
      Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
      return u.toString();
    };

    return [
      make({ vote: String(vote) }),
      make({ Vote: `Vote${vote}` }),
      make({ q: String(vote) }),
      make({ id: String(vote) }),

      make({ action: "get", vote: String(vote) }),
      make({ action: "results", vote: String(vote) }),
      make({ action: "read", vote: String(vote) }),

      make({ mode: "get", vote: String(vote) }),
      make({ mode: "results", vote: String(vote) }),

      // JSONP (si ton script le gÃ¨re)
      make({ action: "get", vote: String(vote), callback: "cb" }),
      make({ vote: String(vote), callback: "cb" }),
    ];
  }

  async function load(){
    const vote = parseVote();
    $("voteLabel").textContent = `VOTE ${vote}`;

    const poll = (window.POLLS || {})[vote];
    if(!poll){
      showError(`Question manquante dans polls.js : window.POLLS[${vote}]`);
      return;
    }

    hideError();
    render(poll, {A:0,B:0,C:0,D:0,E:0});

    const candidates = buildCandidates(vote);

    let lastErr = null;
    for (const url of candidates){
      try{
        $("endpointLabel").textContent = url.replace(SCRIPT_URL, "/exec");
        const data = await fetchAsJson(url);
        const counts = normalizeCounts(data);
        render(poll, counts);
        $("hint").textContent += `  (source OK)`;
        return;
      }catch(e){
        lastErr = e;
      }
    }

    showError(
      "Impossible dâ€™obtenir des rÃ©sultats en JSON depuis lâ€™Apps Script.\n\n" +
      "DerniÃ¨re erreur:\n" + String(lastErr?.message || lastErr) + "\n\n" +
      "ðŸ‘‰ Fais ce test : ouvre ton /exec dans un onglet et dis-moi ce que tu vois.\n" +
      SCRIPT_URL
    );
  }

  let timer = null;
  let auto = false;

  $("refreshBtn").addEventListener("click", load);

  $("toggleAutoBtn").addEventListener("click", () => {
    auto = !auto;
    $("autoLabel").textContent = auto ? "ON" : "OFF";
    if(timer){ clearInterval(timer); timer = null; }
    if(auto){
      load();
      timer = setInterval(load, 5000);
    }
  });

  $("backBtn").addEventListener("click", () => {
    const vote = parseVote();
    location.href = `./vote.html?vote=${vote}`;
  });

  load();
})();
</script>
</body>
</html>
