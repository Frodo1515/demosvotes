<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Résultats en direct</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#111; color:#fff; padding:20px; }
    h1 { text-align:center; margin-bottom: 0.5rem; }
    .subtitle { text-align:center; opacity:0.75; margin-bottom: 1.2rem; }
    .bar-container { max-width: 900px; margin: 0 auto; }
    .bar-row { display:flex; align-items:center; gap:10px; margin: 0.55rem 0; }
    .label { width: 48%; }
    .bar { flex: 1; background:#333; border-radius:6px; overflow:hidden; }
    .bar-fill { height: 24px; background:#4caf50; width:0; transition: width 0.5s; }
    .value { width: 18%; text-align:right; font-variant-numeric: tabular-nums; }
    .total { text-align:center; margin-top: 1rem; font-size: 1.1rem; opacity: 0.85; }
    .error { text-align:center; margin-top: 1rem; color:#ffb3b3; display:none; }
    .hint { text-align:center; margin-top: .5rem; opacity:.6; font-size:.9rem; }
  </style>
</head>
<body>
  <h1 id="title">Résultats en direct</h1>
  <div class="subtitle" id="question"></div>

  <div class="bar-container" id="bars"></div>

  <div class="total" id="total">Total des votes : 0</div>
  <div class="hint" id="hint">Astuce : ajoute ?poll=vote1 … ?poll=vote8 dans l’URL</div>
  <div class="error" id="error">Erreur de récupération des résultats (script / accès / JSON).</div>

  <script>
    // ✅ TON URL Apps Script /exec
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfHhgAvrqguR88WYrYNmbMcVeHikMl_c2RFJr-jLfhOhFGsW3nsISAuo7kGKCSYXtp/exec";

    // Questions + réponses
    const POLLS = {
      vote1: {
        title: "Vote 1",
        question: "Aujourd’hui, la place donnée aux habitants dans les décisions locales est plutôt…",
        answers: { A:"Satisfaisante", B:"Insuffisante", C:"Injuste ou déséquilibrée", D:"Je ne sais pas / je ne me prononce pas" }
      },
      vote2: {
        title: "Vote 2",
        question: "Quand la collectivité consulte les habitants, vous avez le sentiment que l’avis exprimé est…",
        answers: { A:"Réellement pris en compte", B:"Écouté mais rarement décisif", C:"Surtout symbolique", D:"Je n’ai jamais participé / je ne sais pas" }
      },
      vote3: {
        title: "Vote 3",
        question: "Sur quel type de décisions les habitants devraient-ils avoir le plus de poids ?",
        answers: { A:"Le cadre de vie et l’environnement", B:"Les services publics et le quotidien", C:"Les grands projets et orientations budgétaires", D:"Je ne sais pas / je n’y ai jamais réfléchi" }
      },
      vote4: {
        title: "Vote 4",
        question: "Pour vous, participer au développement de notre territoire, c’est avant tout…",
        answers: { A:"Participer à la création des projets de A à Z", B:"Donner votre avis, mais laisser les élus trancher", C:"Être informé et alerté en cas de soucis", D:"Je ne me sens pas concerné" }
      },
      vote5: {
        title: "Vote 5",
        question: "Une plateforme citoyenne sous la forme d’une application ou/et un site internet vous paraît…",
        answers: { A:"Indispensable aujourd’hui", B:"Utile, mais pas prioritaire", C:"Peu adaptée à notre territoire", D:"Je ne vois pas bien ce que c’est" }
      },
      vote6: {
        title: "Vote 6",
        question: "Ce qui vous donnerait le plus envie d’utiliser une plateforme citoyenne, ce serait…",
        answers: { A:"Être informé clairement des projets", B:"Pouvoir donner mon avis facilement", C:"Voir des décisions changer concrètement", D:"Les 3 réponses précédentes (ABC)", E:"Rien, je n’utiliserais pas ce type d’outil" }
      },
      vote7: {
        title: "Vote 7",
        question: "Une plateforme citoyenne devrait avant tout garantir…",
        answers: { A:"La transparence des décisions", B:"L’égalité de parole entre habitants", C:"Le suivi et les résultats concrets des projets", D:"Les 3 réponses précédentes (ABC)", E:"Je ne sais pas ce que j’en attends" }
      },
      vote8: {
        title: "Vote 8",
        question: "Si vos contributions à une plateforme citoyenne avaient un réel poids, vous seriez…",
        answers: { A:"Prêt à participer régulièrement", B:"Prêt à participer ponctuellement", C:"Peu ou pas intéressé", D:"Je préfère rester en dehors de ces démarches" }
      }
    };

    function getPollId() {
      const url = new URL(window.location.href);
      return (url.searchParams.get('poll') || 'vote1').toLowerCase();
    }

    function toApiVoteKey(pollId) {
      // pollId = "vote1" -> "Vote1"
      return pollId.replace(/^vote/i, "Vote");
    }

    function buildBars(pollConfig) {
      const container = document.getElementById('bars');
      container.innerHTML = '';
      Object.entries(pollConfig.answers).forEach(([key, label]) => {
        const row = document.createElement('div');
        row.className = 'bar-row';
        row.innerHTML = `
          <div class="label"><strong>${key}</strong> – ${label}</div>
          <div class="bar"><div class="bar-fill" id="bar${key}"></div></div>
          <div class="value" id="val${key}">0</div>
        `;
        container.appendChild(row);
      });
    }

    function setHeader(pollId, pollConfig) {
      document.getElementById('title').textContent = `Résultats en direct – ${pollConfig.title}`;
      document.getElementById('question').textContent = pollConfig.question;
      document.title = `Résultats en direct – ${pollConfig.title}`;
    }

    async function fetchResults(pollId, pollConfig) {
      const errorEl = document.getElementById('error');
      try {
        // Notre API renvoie TOUS les votes (Vote1|A, Vote2|B, etc.)
        const res = await fetch(`${SCRIPT_URL}?nocache=${Date.now()}`, { cache: 'no-store' });
        const data = await res.json();

        const apiVote = toApiVoteKey(pollId); // "Vote1"
        let total = 0;
        const counts = {};

        for (const key of Object.keys(pollConfig.answers)) {
          const apiKey = `${apiVote}|${key}`;   // ex "Vote1|A"
          const n = Number(data[apiKey] || 0);
          counts[key] = n;
          total += n;
        }

        const percent = (v) => total > 0 ? (v / total) * 100 : 0;

        for (const key of Object.keys(pollConfig.answers)) {
          const p = percent(counts[key]);
          const bar = document.getElementById(`bar${key}`);
          const val = document.getElementById(`val${key}`);
          if (bar) bar.style.width = p + '%';
          if (val) val.textContent = `${counts[key]} (${p.toFixed(0)}%)`;
        }

        document.getElementById('total').textContent = `Total des votes : ${total}`;
        errorEl.style.display = 'none';
      } catch (e) {
        console.error(e);
        errorEl.style.display = 'block';
      }
    }

    // init
    const pollId = getPollId();
    const pollConfig = POLLS[pollId] || POLLS.vote1;

    setHeader(pollId, pollConfig);
    buildBars(pollConfig);

    fetchResults(pollId, pollConfig);
    setInterval(() => fetchResults(pollId, pollConfig), 2000);
  </script>
</body>
</html>
