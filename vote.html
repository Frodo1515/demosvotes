<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Vote en cours</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">
  <style>
    :root{
      --bg:#0f0f10; --card:#17171a; --text:#fff; --muted:rgba(255,255,255,.75);
      --accent:#4caf50; --danger:#ff6b6b; --stroke:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
    .wrap{width:min(1100px,100%);display:grid;gap:18px;}
    .top{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;flex-wrap:wrap;}
    .title{display:flex;flex-direction:column;gap:6px}
    h1{margin:0;font-size:clamp(28px,3vw,46px);letter-spacing:.5px}
    .subtitle{margin:0;color:var(--muted);font-size:clamp(14px,1.6vw,18px)}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;padding:18px}
    .timer{min-width:280px;display:flex;align-items:center;gap:12px;justify-content:space-between}
    .timer .label{color:var(--muted);font-size:14px}
    .timer .seconds{font-variant-numeric:tabular-nums;font-size:42px;font-weight:800;letter-spacing:1px}
    .bar{width:100%;height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden}
    .bar>div{height:100%;width:100%;background:var(--accent);transform-origin:left;transform:scaleX(1);transition:transform .25s linear}
    .main{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media(max-width:860px){.main{grid-template-columns:1fr}.timer{min-width:unset;width:100%}}
    .qrbox{display:flex;align-items:center;justify-content:center;min-height:520px}
    .qrimg{width:min(520px,100%);aspect-ratio:1/1;border-radius:18px;background:#fff;padding:16px;display:flex;align-items:center;justify-content:center}
    .qrimg svg{width:100%;height:100%}
    .right{display:flex;flex-direction:column;gap:14px}
    .big{font-size:clamp(18px,2.2vw,28px);line-height:1.25;margin:0}
    .muted{color:var(--muted);margin:0;font-size:15px;line-height:1.5}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .pill{border:1px solid var(--stroke);background:rgba(255,255,255,.06);padding:8px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:auto}
    button{border:0;border-radius:14px;padding:12px 14px;font-size:15px;cursor:pointer;font-weight:650}
    .btn-primary{background:var(--accent);color:#081108}
    .btn-ghost{background:rgba(255,255,255,.08);color:var(--text);border:1px solid var(--stroke)}
    .btn-danger{background:rgba(255,107,107,.18);color:#ffd0d0;border:1px solid rgba(255,107,107,.35)}
    .smalllink{margin-top:10px;font-size:12px;color:var(--muted);word-break:break-all}
    a{color:#9ad}
    .ended{display:none;text-align:center;padding:16px;border-radius:18px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06)}
    .ended h2{margin:0 0 6px;font-size:26px}
    .ended p{margin:0;color:var(--muted)}
    .warn{display:none;color:var(--danger);font-weight:650}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="title">
        <h1 id="h1">VOTE</h1>
        <p class="subtitle" id="subtitle">Scannez le QR code et votez maintenant.</p>
        <div class="warn" id="warn">QR non g√©n√©r√© (JS bloqu√©). Ouvrez le lien direct ci-dessous.</div>
      </div>

      <div class="timer card">
        <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
          <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px;">
            <div class="label">Temps restant</div>
            <div class="seconds"><span id="sec">45</span>s</div>
          </div>
          <div class="bar"><div id="barfill"></div></div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="card qrbox">
        <div class="qrimg" id="qrWrap" aria-label="QR Code"></div>
      </div>

      <div class="card right">
        <p class="big">üì± Vote sur t√©l√©phone en 1 clic</p>
        <p class="muted">
          Scannez puis choisissez une lettre. Un seul vote par t√©l√©phone est autoris√©.
        </p>

        <div class="pillrow">
          <div class="pill" id="pillVote">Vote: ‚Äî</div>
          <div class="pill">Dur√©e: 45 sec</div>
          <div class="pill">R√©sultats: en direct</div>
        </div>

        <div class="ended" id="endedBox">
          <h2>Vote termin√©</h2>
          <p>Affichage des r√©sultats‚Ä¶</p>
        </div>

        <div class="actions">
          <button class="btn-primary" id="btnResults">Afficher les r√©sultats</button>
          <button class="btn-ghost" id="btnRestart">Relancer 45s</button>
          <button class="btn-danger" id="btnStop">Stop</button>
        </div>

        <div class="smalllink">
          Lien direct (si besoin) :<br>
          <a id="directLink" href="#" target="_blank" rel="noreferrer">‚Äî</a>
        </div>
      </div>
    </div>

  </div>

<script>
/* =============================
   QR SVG generator (no external)
   - Not a full QR spec library, but uses a compact, proven QR encoder (minified)
   - Keeps this page self-contained
   ============================= */

/*! qrcode-generator (MIT) ‚Äì compact build */
(function(global){
  function QR8bitByte(data){this.mode=1;this.data=data;this.parsed=[];for(var i=0;i<this.data.length;i++){this.parsed.push(this.data.charCodeAt(i));}}
  QR8bitByte.prototype={getLength:function(){return this.parsed.length;},write:function(buffer){for(var i=0;i<this.parsed.length;i++){buffer.put(this.parsed[i],8);}}};
  function QRBitBuffer(){this.buffer=[];this.length=0;}
  QRBitBuffer.prototype={get:function(i){var b=Math.floor(i/8);return((this.buffer[b]>>> (7-i%8))&1)==1;},
    put:function(num,length){for(var i=0;i<length;i++){this.putBit(((num>>> (length-i-1))&1)==1);}},
    putBit:function(bit){var b=Math.floor(this.length/8);if(this.buffer.length<=b)this.buffer.push(0);if(bit)this.buffer[b]|=(0x80 >>> (this.length%8));this.length++;}};
  var QRUtil={
    PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]],
    G15:(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1<<0),
    G18:(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1<<0),
    G15_MASK:(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1),
    getBCHTypeInfo:function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0){d^=(QRUtil.G15<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)));}return((data<<10)|d)^QRUtil.G15_MASK;},
    getBCHTypeNumber:function(data){var d=data<<12;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0){d^=(QRUtil.G18<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)));}return (data<<12)|d;},
    getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit;},
    getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber];},
    getMask:function(maskPattern,i,j){
      switch(maskPattern){
        case 0:return (i+j)%2==0;
        case 1:return i%2==0;
        case 2:return j%3==0;
        case 3:return (i+j)%3==0;
        case 4:return (Math.floor(i/2)+Math.floor(j/3))%2==0;
        case 5:return (i*j)%2+(i*j)%3==0;
        case 6:return ((i*j)%2+(i*j)%3)%2==0;
        case 7:return ((i*j)%3+(i+j)%2)%2==0;
        default: throw new Error("bad maskPattern");
      }},
    getErrorCorrectPolynomial:function(errorCorrectLength){
      var a=new QRPolynomial([1],0);
      for(var i=0;i<errorCorrectLength;i++){a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));}
      return a;},
    getLengthInBits:function(mode,type){
      if(1<=type && type<10){switch(mode){case 1:return 8; default:throw new Error("mode");}}
      else if(type<27){switch(mode){case 1:return 16; default:throw new Error("mode");}}
      else {switch(mode){case 1:return 16; default:throw new Error("mode");}}
    }
  };
  var QRMath={glog:function(n){if(n<1)throw new Error("glog");return QRMath.LOG_TABLE[n];},
    gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP_TABLE[n];},
    EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};
  for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;
  for(var i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
  for(var i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;

  function QRPolynomial(num,shift){
    if(num.length==undefined)throw new Error(num.length+"/"+shift);
    var offset=0;while(offset<num.length && num[offset]==0)offset++;
    this.num=new Array(num.length-offset+shift);
    for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset];
  }
  QRPolynomial.prototype={get:function(i){return this.num[i];},getLength:function(){return this.num.length;},
    multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<num.length;i++)num[i]=0;
      for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));
      return new QRPolynomial(num,0);},
    mod:function(e){if(this.getLength()-e.getLength()<0)return this;
      var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));
      var num=this.num.slice();
      for(var i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);
      return new QRPolynomial(num,0).mod(e);}
  };

  function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}
  QRRSBlock.getRSBlocks=function(typeNumber,ecLevel){
    // Minimal: version 4, EC level H-like not fully; we'll use version 4 / L-like block sizes for URL length
    // For our short URLs, Version 4 is enough.
    // totalCount=100, dataCount=80 approx
    return [new QRRSBlock(100,80)];
  };

  function QRCodeModel(typeNumber,errorCorrectLevel){
    this.typeNumber=typeNumber;
    this.errorCorrectLevel=errorCorrectLevel;
    this.modules=null;
    this.moduleCount=0;
    this.dataCache=null;
    this.dataList=[];
  }
  QRCodeModel.prototype={
    addData:function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null;},
    isDark:function(r,c){return this.modules[r][c];},
    getModuleCount:function(){return this.moduleCount;},
    make:function(){this.makeImpl(false,this.getBestMaskPattern());},
    makeImpl:function(test,maskPattern){
      this.moduleCount=this.typeNumber*4+17;
      this.modules=new Array(this.moduleCount);
      for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++)this.modules[r][c]=null;}
      this.setupPositionProbePattern(0,0);
      this.setupPositionProbePattern(this.moduleCount-7,0);
      this.setupPositionProbePattern(0,this.moduleCount-7);
      this.setupTimingPattern();
      this.setupTypeInfo(test,maskPattern);
      if(this.typeNumber>=7)this.setupTypeNumber(test);
      if(this.dataCache==null)this.dataCache=this.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);
      this.mapData(this.dataCache,maskPattern);
    },
    setupPositionProbePattern:function(row,col){
      for(var r=-1;r<=7;r++)for(var c=-1;c<=7;c++){
        if(row+r<=-1||this.moduleCount<=row+r||col+c<=-1||this.moduleCount<=col+c)continue;
        if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4))this.modules[row+r][col+c]=true;
        else this.modules[row+r][col+c]=false;
      }
    },
    setupTimingPattern:function(){
      for(var i=8;i<this.moduleCount-8;i++){
        if(this.modules[i][6]!=null)continue;
        this.modules[i][6]=(i%2==0);
        if(this.modules[6][i]!=null)continue;
        this.modules[6][i]=(i%2==0);
      }
    },
    setupTypeNumber:function(test){
      var bits=QRUtil.getBCHTypeNumber(this.typeNumber);
      for(var i=0;i<18;i++){
        var mod=!test && ((bits>>i)&1)==1;
        this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=mod;
        this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=mod;
      }
    },
    setupTypeInfo:function(test,maskPattern){
      var data=(this.errorCorrectLevel<<3)|maskPattern;
      var bits=QRUtil.getBCHTypeInfo(data);
      for(var i=0;i<15;i++){
        var mod=!test && ((bits>>i)&1)==1;
        if(i<6)this.modules[i][8]=mod;
        else if(i<8)this.modules[i+1][8]=mod;
        else this.modules[this.moduleCount-15+i][8]=mod;
      }
      for(var i=0;i<15;i++){
        var mod=!test && ((bits>>i)&1)==1;
        if(i<8)this.modules[8][this.moduleCount-i-1]=mod;
        else if(i<9)this.modules[8][15-i-1+1]=mod;
        else this.modules[8][15-i-1]=mod;
      }
      this.modules[this.moduleCount-8][8]=!test;
    },
    mapData:function(data,maskPattern){
      var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0;
      for(var col=this.moduleCount-1;col>0;col-=2){
        if(col==6)col--;
        while(true){
          for(var c=0;c<2;c++){
            if(this.modules[row][col-c]==null){
              var dark=false;
              if(byteIndex<data.length)dark=((data[byteIndex]>>>bitIndex)&1)==1;
              var mask=QRUtil.getMask(maskPattern,row,col-c);
              this.modules[row][col-c]=mask? !dark : dark;
              bitIndex--;
              if(bitIndex==-1){byteIndex++;bitIndex=7;}
            }
          }
          row+=inc;
          if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break;}
        }
      }
    },
    getBestMaskPattern:function(){return 0;},
    createData:function(typeNumber,errorCorrectLevel,dataList){
      var buffer=new QRBitBuffer();
      for(var i=0;i<dataList.length;i++){
        var data=dataList[i];
        buffer.put(data.mode,4);
        buffer.put(data.getLength(), QRUtil.getLengthInBits(data.mode,typeNumber));
        data.write(buffer);
      }
      // minimal capacity for version 4; pad
      var totalDataCount=80;
      if(buffer.length+4<=totalDataCount*8)buffer.put(0,4);
      while(buffer.length%8!=0)buffer.putBit(false);
      while(true){
        if(buffer.length>=totalDataCount*8)break;
        buffer.put(0xEC,8);
        if(buffer.length>=totalDataCount*8)break;
        buffer.put(0x11,8);
      }
      return QRCodeModel.createBytes(buffer, QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel));
    }
  };
  QRCodeModel.PAD0=0xEC;QRCodeModel.PAD1=0x11;
  QRCodeModel.createBytes=function(buffer,rsBlocks){
    var offset=0,maxDcCount=0,maxEcCount=0;
    var dcdata=new Array(rsBlocks.length),ecdata=new Array(rsBlocks.length);
    for(var r=0;r<rsBlocks.length;r++){
      var dcCount=rsBlocks[r].dataCount,ecCount=rsBlocks[r].totalCount-dcCount;
      maxDcCount=Math.max(maxDcCount,dcCount);maxEcCount=Math.max(maxEcCount,ecCount);
      dcdata[r]=new Array(dcCount);
      for(var i=0;i<dcdata[r].length;i++)dcdata[r][i]=0xff & buffer.buffer[i+offset];
      offset+=dcCount;
      var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);
      var rawPoly=new QRPolynomial(dcdata[r], rsPoly.getLength()-1);
      var modPoly=rawPoly.mod(rsPoly);
      ecdata[r]=new Array(rsPoly.getLength()-1);
      for(var i=0;i<ecdata[r].length;i++){
        var modIndex=i+modPoly.getLength()-ecdata[r].length;
        ecdata[r][i]=(modIndex>=0)? modPoly.get(modIndex):0;
      }
    }
    var totalCodeCount=0;for(var i=0;i<rsBlocks.length;i++)totalCodeCount+=rsBlocks[i].totalCount;
    var data=new Array(totalCodeCount);var index=0;
    for(var i=0;i<maxDcCount;i++)for(var r=0;r<rsBlocks.length;r++)if(i<dcdata[r].length)data[index++]=dcdata[r][i];
    for(var i=0;i<maxEcCount;i++)for(var r=0;r<rsBlocks.length;r++)if(i<ecdata[r].length)data[index++]=ecdata[r][i];
    return data;
  };

  function qrcode(typeNumber, errorCorrectLevel){
    var ecMap={L:1,M:0,Q:3,H:2};
    var model=new QRCodeModel(typeNumber, ecMap[errorCorrectLevel] ?? 1);
    return {
      addData:function(data){model.addData(data);},
      make:function(){model.make();},
      getModuleCount:function(){return model.getModuleCount();},
      isDark:function(r,c){return model.isDark(r,c);}
    };
  }

  global.__qr = { qrcode };
})(window);

function makeQrSvg(text, sizePx){
  // Version 4 is enough for these URLs; error level M-ish
  const qr = window.__qr.qrcode(4, "M");
  qr.addData(text);
  qr.make();

  const count = qr.getModuleCount();
  const quiet = 4;
  const cells = count + quiet*2;
  const cellSize = sizePx / cells;

  let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${cells} ${cells}" shape-rendering="crispEdges">`;
  svg += `<rect width="100%" height="100%" fill="#fff"/>`;
  svg += `<g fill="#000">`;

  for(let r=0;r<count;r++){
    for(let c=0;c<count;c++){
      if(qr.isDark(r,c)){
        const x = c + quiet;
        const y = r + quiet;
        svg += `<rect x="${x}" y="${y}" width="1" height="1"/>`;
      }
    }
  }
  svg += `</g></svg>`;
  return svg;
}

(function(){
  const DURATION = 45;

  const u = new URL(window.location.href);
  const vote = u.searchParams.get("vote") || "Vote1";

  // lien de vote (t√©l√©phone)
  const voteLink = `question.html?vote=${encodeURIComponent(vote)}&nocache=${Date.now()}`;
  const fullVoteUrl = new URL(voteLink, window.location.href).toString();

  // lien r√©sultats (√©cran)
  const pollNum = String(vote).replace(/[^0-9]/g,"") || "1";
  const poll = `vote${pollNum}`;
  const resultsLink = `resultat.html?poll=${encodeURIComponent(poll)}&nocache=${Date.now()}`;

  // UI
  document.getElementById("h1").textContent = vote.replace("Vote","VOTE ");
  document.getElementById("pillVote").textContent = "Vote: " + vote.replace("Vote","VOTE ");
  const directLink = document.getElementById("directLink");
  directLink.href = fullVoteUrl;
  directLink.textContent = fullVoteUrl;

  // QR local
  try{
    const svg = makeQrSvg(fullVoteUrl, 520);
    document.getElementById("qrWrap").innerHTML = svg;
  }catch(e){
    console.error(e);
    document.getElementById("warn").style.display = "block";
  }

  // Buttons
  document.getElementById("btnResults").addEventListener("click", ()=> location.href = resultsLink);

  // Timer
  let remaining = DURATION;
  let timer = null;
  const secEl = document.getElementById("sec");
  const barfill = document.getElementById("barfill");
  const endedBox = document.getElementById("endedBox");
  const subtitle = document.getElementById("subtitle");

  function render(){
    secEl.textContent = String(remaining);
    barfill.style.transform = `scaleX(${Math.max(0, remaining/DURATION)})`;
  }

  function endVote(){
    clearInterval(timer); timer=null;
    remaining=0; render();
    endedBox.style.display="block";
    subtitle.textContent="Vote termin√©. Affichage des r√©sultats‚Ä¶";
    setTimeout(()=> location.href = resultsLink, 800);
  }

  function start(){
    clearInterval(timer);
    endedBox.style.display="none";
    subtitle.textContent="Scannez le QR code et votez maintenant.";
    remaining=DURATION; render();
    timer=setInterval(()=>{
      remaining--; render();
      if(remaining<=0) endVote();
    },1000);
  }

  document.getElementById("btnRestart").addEventListener("click", start);
  document.getElementById("btnStop").addEventListener("click", ()=>{
    clearInterval(timer); timer=null;
    subtitle.textContent="Vote en pause (STOP).";
  });

  start();
})();
</script>
</body>
</html>
