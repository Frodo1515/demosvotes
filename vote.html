<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vote – Affichage</title>

  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#9aa7c7;
      --text:#ffffff;
      --accent:#4fd1c5;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(79,209,197,.15), transparent 60%),
                  radial-gradient(900px 600px at 90% 30%, rgba(154,167,199,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 22px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      font-size:20px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .meta{
      color:var(--muted);
      font-size:14px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      padding:6px 10px;
      border-radius:999px;
    }

    main{
      padding:22px;
    }
    .grid{
      display:grid;
      grid-template-columns: 430px 1fr;
      gap:22px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      min-height: 520px;
    }

    .qrWrap{
      display:flex;
      flex-direction:column;
      gap:14px;
      height:100%;
    }
    .qrBox{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:16px;
      background: rgba(0,0,0,.18);
      border:1px dashed rgba(255,255,255,.18);
      padding:16px;
    }
    .qrBox img{
      max-width:100%;
      max-height: 440px;
      object-fit:contain;
      image-rendering: auto;
    }
    .qrCaption{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .qrLabel{
      font-weight:800;
      font-size:22px;
      letter-spacing:.6px;
    }
    .small{
      color:var(--muted);
      font-size:13px;
    }

    .questionTitle{
      font-size:26px;
      font-weight:800;
      line-height:1.2;
      margin:0 0 14px 0;
    }
    .options{
      display:grid;
      gap:12px;
      margin-top:14px;
    }
    .opt{
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-size:18px;
      line-height:1.25;
    }

    .timerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:18px;
      flex-wrap:wrap;
    }
    .timer{
      display:flex;
      align-items:baseline;
      gap:10px;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .timer .num{
      font-size:34px;
      font-weight:900;
      color:var(--accent);
      min-width: 64px;
      text-align:right;
    }
    .timer .unit{
      color:var(--muted);
      font-weight:600;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    .danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.12);
    }
    .danger:hover{ background: rgba(255,107,107,.18); }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
    .error{
      color:#ffd1d1;
      background: rgba(255,107,107,.12);
      border:1px solid rgba(255,107,107,.35);
      padding:10px 12px;
      border-radius:14px;
      margin-top:12px;
      display:none;
    }
    .topRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .select{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-weight:700;
    }
    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }
  </style>
</head>

<body>
  <header>
    <div>
      <div class="title">DÉMOS – Affichage du vote</div>
      <div class="meta">
        <span class="pill">QR à gauche · Question à droite · 45 s</span>
        <span class="pill">URL : <span id="urlEcho"></span></span>
      </div>
    </div>

    <div class="topRight">
      <label class="meta" for="voteSelect">Vote :</label>
      <select id="voteSelect" class="select">
        <option value="1">Vote 1</option>
        <option value="2">Vote 2</option>
        <option value="3">Vote 3</option>
        <option value="4">Vote 4</option>
        <option value="5">Vote 5</option>
        <option value="6">Vote 6</option>
        <option value="7">Vote 7</option>
        <option value="8">Vote 8</option>
      </select>
      <button id="applyVoteBtn">Afficher</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT: QR -->
      <section class="card">
        <div class="qrWrap">
          <div class="qrBox">
            <img id="qrImg" alt="QR Code du vote" />
          </div>
          <div class="qrCaption">
            <div>
              <div class="qrLabel" id="qrLabel">VOTE 1</div>
              <div class="small">Scannez pour voter sur votre téléphone</div>
            </div>
            <div class="small">
              Image : <span id="qrPath"></span>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: QUESTION -->
      <section class="card">
        <h1 class="questionTitle" id="qTitle">Chargement…</h1>

        <div class="options" id="qOptions"></div>

        <div class="timerRow">
          <div class="timer" aria-live="polite">
            <div class="num" id="timeLeft">45</div>
            <div class="unit">secondes</div>
          </div>

          <div class="btns">
            <button class="danger" id="stopBtn">STOP</button>
            <button id="restartBtn">RELANCER (45s)</button>
            <button id="toResultsBtn">Aller aux résultats</button>
          </div>
        </div>

        <div class="hint">
          Astuce : tu peux aussi changer le vote dans l’URL : <code>?vote=1</code> … <code>?vote=8</code>
        </div>

        <div class="error" id="errBox"></div>
      </section>
    </div>
  </main>

  <!-- Données des questions -->
  <script src="./polls.js"></script>

  <script>
    (function(){
      const DEFAULT_DURATION = 45;

      const $ = (id) => document.getElementById(id);

      const url = new URL(window.location.href);
      $("urlEcho").textContent = url.pathname + url.search;

      const errBox = $("errBox");

      // Lire ?vote=1..8 (ou Vote1/VOTE_1 etc, on tolère)
      function parseVoteParam() {
        let v = url.searchParams.get("vote") || "1";
        v = String(v).trim();
        // accepte "Vote1" "VOTE_1" "1"
        const m = v.match(/(\d+)/);
        const n = m ? parseInt(m[1], 10) : 1;
        return (n >= 1 && n <= 8) ? n : 1;
      }

      function padVoteLabel(n){
        return `VOTE ${n}`;
      }

      function qrImagePath(n){
        // Dossier qrs + nom VOTE_1.png
        return `./qrs/VOTE_${n}.png`;
      }

      function renderVote(n){
        // Label / Select
        $("qrLabel").textContent = padVoteLabel(n);
        $("voteSelect").value = String(n);

        // QR
        const path = qrImagePath(n);
        $("qrPath").textContent = path;
        $("qrImg").src = path;

        // Question
        const polls = window.POLLS || {};
        const poll = polls[n];

        if(!poll){
          showError(`Aucune question trouvée pour le vote ${n}. Vérifie polls.js (window.POLLS[${n}]).`);
          $("qTitle").textContent = `Vote ${n} : question manquante`;
          $("qOptions").innerHTML = "";
          return;
        }

        hideError();
        $("qTitle").textContent = poll.title || `Vote ${n}`;
        $("qOptions").innerHTML = "";

        (poll.options || []).forEach((txt) => {
          const div = document.createElement("div");
          div.className = "opt";
          div.textContent = txt;
          $("qOptions").appendChild(div);
        });
      }

      function showError(msg){
        errBox.style.display = "block";
        errBox.textContent = msg;
      }
      function hideError(){
        errBox.style.display = "none";
        errBox.textContent = "";
      }

      // Timer
      let remaining = DEFAULT_DURATION;
      let intervalId = null;

      function updateTimer(){
        $("timeLeft").textContent = String(remaining);
        if(remaining <= 10){
          $("timeLeft").style.color = "var(--danger)";
        } else {
          $("timeLeft").style.color = "var(--accent)";
        }
      }

      function startTimer(){
        stopTimer();
        intervalId = setInterval(() => {
          remaining -= 1;
          updateTimer();
          if(remaining <= 0){
            stopTimer();
            // Optionnel : bascule auto vers résultats
            // Décommente la ligne suivante si tu veux l'auto-bascule :
            // goToResults();
          }
        }, 1000);
      }

      function stopTimer(){
        if(intervalId){
          clearInterval(intervalId);
          intervalId = null;
        }
      }

      function resetTimer(){
        remaining = DEFAULT_DURATION;
        updateTimer();
      }

      function goToResults(){
        const currentVote = parseInt($("voteSelect").value, 10) || 1;
        // adapte ici si ton fichier s'appelle resultat.html ou resultats.html
        window.location.href = `./resultats.html?vote=${currentVote}`;
      }

      // UI events
      $("stopBtn").addEventListener("click", () => {
        stopTimer();
      });

      $("restartBtn").addEventListener("click", () => {
        resetTimer();
        startTimer();
      });

      $("toResultsBtn").addEventListener("click", () => {
        goToResults();
      });

      $("applyVoteBtn").addEventListener("click", () => {
        const n = parseInt($("voteSelect").value, 10) || 1;
        // On recharge la page avec le bon paramètre pour que l'URL reflète le vote
        window.location.href = `./vote.html?vote=${n}`;
      });

      // Init
      const voteN = parseVoteParam();
      renderVote(voteN);
      resetTimer();
      startTimer();
    })();
  </script>
</body>
</html>
