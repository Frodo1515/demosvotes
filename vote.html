<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vote â€“ DÃ‰MOS</title>
  <style>
    :root{
      --bg:#0f0f10;
      --panel:#17171a;
      --stroke:rgba(255,255,255,.14);
      --text:#ffffff;
      --muted:rgba(255,255,255,.75);
      --accent:#4caf50;
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      background:var(--panel);
      border-bottom:1px solid var(--stroke);
      flex-wrap:wrap;
    }
    .leftHead{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .badge{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      padding:4px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:13px;
    }
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.accent{border-color:rgba(76,175,80,.55)}
    .btn.danger{border-color:rgba(255,107,107,.55)}

    main{
      padding:16px;
      display:flex;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      main{flex-direction:column;}
    }

    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:16px;
      min-height:420px;
    }

    /* Colonne QR */
    .colQR{width:520px; max-width:520px; flex:0 0 auto;}
    @media (max-width: 980px){
      .colQR{width:auto; max-width:none;}
    }
    .qrWrap{display:flex; flex-direction:column; gap:12px;}
    .qrTitle{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .qrTitle h1{font-size:22px; margin:0; font-weight:950;}
    .qrSubtitle{color:var(--muted); font-size:14px}

    .qrBox{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:16px;
      background:rgba(255,255,255,.04);
      border:1px dashed rgba(255,255,255,.20);
      padding:14px;
      min-height:320px;
    }
    img#qrImg{
      max-width:100%;
      max-height:520px;
      object-fit:contain;
      border-radius:14px;
      background:#fff;
      padding:10px;
      display:block;
    }
    .qrError{
      display:none;
      width:100%;
      color:rgba(255,255,255,.9);
      background:rgba(255,107,107,.12);
      border:1px solid rgba(255,107,107,.35);
      padding:12px 14px;
      border-radius:14px;
      font-size:14px;
      line-height:1.35;
    }

    .timerRow{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .timeBig{font-size:44px; font-weight:950; letter-spacing:.5px;}
    .progress{
      width:100%;
      height:12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bar{height:100%; width:0%; background:var(--accent); border-radius:999px; transition:width .2s linear;}

    /* Colonne Question */
    .colQ{flex:1 1 auto; min-width:320px;}
    .qWrap{display:flex; flex-direction:column; gap:12px;}
    .qWrap h2{margin:0; font-size:28px; font-weight:950; line-height:1.15;}
    .choices{margin:0; padding-left:22px; font-size:20px; line-height:1.5;}
    .choices li{
      margin:10px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
    }
    .footNote{
      margin-top:12px;
      color:var(--muted);
      font-size:14px;
      border-top:1px solid var(--stroke);
      padding-top:12px;
    }

    /* Overlay fin */
    .overlay{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,.75);
      z-index:50; padding:20px;
    }
    .overlay .box{
      max-width:680px; width:100%;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:20px;
      padding:22px;
      text-align:center;
    }
    .overlay .box h3{margin:0 0 8px 0; font-size:28px; font-weight:950;}
    .overlay .box p{margin:0; color:var(--muted); font-size:16px;}
  </style>
</head>

<body>
<header>
  <div class="leftHead">
    <div class="badge" id="badgeVote">VOTE</div>
    <div class="badge" id="badgeUrl">QR â†’ â€¦</div>
  </div>
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <button class="btn" id="btnRestart" title="Relancer le timer">â†» Relancer</button>
    <button class="btn accent" id="btnFullscreen">â›¶ Plein Ã©cran</button>
    <button class="btn danger" id="btnShowResults">ðŸ“Š RÃ©sultats</button>
  </div>
</header>

<main>
  <!-- QR -->
  <section class="card colQR">
    <div class="qrWrap">
      <div class="qrTitle">
        <div>
          <h1>Scannez pour voter</h1>
          <div class="qrSubtitle">Un vote par personne â€¢ DurÃ©e limitÃ©e</div>
        </div>
        <div class="badge">Temps restant</div>
      </div>

      <div class="qrBox" id="qrBox">
        <img id="qrImg" alt="QR Code Vote" />
      </div>

      <div class="qrError" id="qrError"></div>

      <div class="timerRow">
        <div class="timeBig" id="timeLeft">30</div>
        <div class="badge" id="status">Vote ouvert</div>
      </div>

      <div class="progress" aria-label="Progression du vote">
        <div class="bar" id="bar"></div>
      </div>
    </div>
  </section>

  <!-- Question -->
  <section class="card colQ">
    <div class="qWrap">
      <div class="badge">Question & choix</div>
      <h2 id="qTitle">Chargementâ€¦</h2>
      <ol class="choices" id="qChoices"></ol>
      <div class="footNote">Astuce animateur : ajoute <b>&sec=45</b> dans lâ€™URL pour une durÃ©e diffÃ©rente.</div>
    </div>
  </section>
</main>

<div class="overlay" id="overlay">
  <div class="box">
    <h3>Vote terminÃ©</h3>
    <p>Affichage des rÃ©sultatsâ€¦</p>
  </div>
</div>

<script>
  const POLLS = {
    Vote1: {
      question: "Aujourdâ€™hui, la place donnÃ©e aux habitants dans les dÃ©cisions locales est plutÃ´tâ€¦",
      choices: [
        "A â€“ Satisfaisante",
        "B â€“ Insuffisante",
        "C â€“ Injuste ou dÃ©sÃ©quilibrÃ©e",
        "D â€“ Je ne sais pas / je ne me prononce pas"
      ]
    },
    Vote2: {
      question: "Quand la collectivitÃ© consulte les habitants, vous avez le sentiment que lâ€™avis exprimÃ© estâ€¦",
      choices: [
        "A â€“ RÃ©ellement pris en compte",
        "B â€“ Ã‰coutÃ© mais rarement dÃ©cisif",
        "C â€“ Surtout symbolique",
        "D â€“ Je nâ€™ai jamais participÃ© / je ne sais pas"
      ]
    },
    Vote3: {
      question: "Sur quel type de dÃ©cisions les habitants devraient-ils avoir le plus de poids ?",
      choices: [
        "A â€“ Le cadre de vie et lâ€™environnement",
        "B â€“ Les services publics et le quotidien",
        "C â€“ Les grands projets et orientations budgÃ©taires",
        "D â€“ Je ne sais pas / je nâ€™y ai jamais rÃ©flÃ©chi"
      ]
    },
    Vote4: {
      question: "Pour vous, participer au dÃ©veloppement de notre territoire, câ€™est avant toutâ€¦",
      choices: [
        "A â€“ De participer Ã  la crÃ©ation des projets de A Ã  Z",
        "B â€“ Donner votre avis, mais laisser les Ã©lus trancher",
        "C â€“ ÃŠtre informÃ© et alertÃ© en cas de soucis",
        "D â€“ Je ne me sens pas concernÃ©"
      ]
    },
    Vote5: {
      question: "Une plateforme citoyenne sous la forme dâ€™une application ou/et un site internet vous paraÃ®tâ€¦",
      choices: [
        "A â€“ Indispensable aujourdâ€™hui",
        "B â€“ Utile, mais pas prioritaire",
        "C â€“ Peu adaptÃ©e Ã  notre territoire",
        "D â€“ Je ne vois pas bien ce que câ€™est"
      ]
    },
    Vote6: {
      question: "Ce qui vous donnerait le plus envie dâ€™utiliser une plateforme citoyenne, ce seraitâ€¦",
      choices: [
        "A â€“ ÃŠtre informÃ© clairement des projets",
        "B â€“ Pouvoir donner mon avis facilement",
        "C â€“ Voir des dÃ©cisions changer concrÃ¨tement",
        "D â€“ Les 3 rÃ©ponses prÃ©cÃ©dentes (ABC)",
        "E â€“ Rien, je nâ€™utiliserais pas ce type dâ€™outil"
      ]
    },
    Vote7: {
      question: "Une plateforme citoyenne devrait avant tout garantirâ€¦",
      choices: [
        "A â€“ La transparence des dÃ©cisions",
        "B â€“ Lâ€™Ã©galitÃ© de parole entre habitants",
        "C â€“ Le suivi et les rÃ©sultats concrets des projets",
        "D â€“ Les 3 rÃ©ponses prÃ©cÃ©dentes (ABC)",
        "E â€“ Je ne sais pas ce que jâ€™en attends"
      ]
    },
    Vote8: {
      question: "Si vos contributions Ã  une plateforme citoyenne avaient un rÃ©el poids, vous seriezâ€¦",
      choices: [
        "A â€“ PrÃªt Ã  participer rÃ©guliÃ¨rement",
        "B â€“ PrÃªt Ã  participer ponctuellement",
        "C â€“ Peu ou pas intÃ©ressÃ©",
        "D â€“ Je prÃ©fÃ¨re rester en dehors de ces dÃ©marches"
      ]
    }
  };

  const qs = new URLSearchParams(location.search);
  const voteKey = qs.get("vote") || "Vote1";
  const secParam = parseInt(qs.get("sec") || "30", 10);
  const DURATION = Number.isFinite(secParam) && secParam > 5 ? secParam : 30;

  const badgeVote = document.getElementById("badgeVote");
  const badgeUrl  = document.getElementById("badgeUrl");
  const qTitle    = document.getElementById("qTitle");
  const qChoices  = document.getElementById("qChoices");
  const qrImg     = document.getElementById("qrImg");
  const qrError   = document.getElementById("qrError");
  const timeLeft  = document.getElementById("timeLeft");
  const bar       = document.getElementById("bar");
  const status    = document.getElementById("status");
  const overlay   = document.getElementById("overlay");

  badgeVote.textContent = voteKey.toUpperCase();

  function voteNumberFromKey(k){
    const m = String(k).match(/(\d+)/);
    return m ? parseInt(m[1], 10) : 1;
  }
  const voteNum = voteNumberFromKey(voteKey);

  // QR: on tente .png puis .PNG (au cas oÃ¹)
  const qrPng = `qrs/VOTE_${voteNum}.png`;
  const qrPNG = `qrs/VOTE_${voteNum}.PNG`;

  function showQrError(tried){
    qrError.style.display = "block";
    qrError.innerHTML =
      `<b>QR introuvable</b><br>` +
      `Chemin essayÃ© : <code>${tried}</code><br>` +
      `ðŸ‘‰ VÃ©rifie le nom exact dans le dossier <code>qrs</code> (casse .png/.PNG).`;
  }

  qrImg.onload = () => { qrError.style.display = "none"; };
  qrImg.onerror = () => {
    // si .png Ã©choue, on essaie .PNG
    if (qrImg.getAttribute("data-tried") !== "PNG") {
      qrImg.setAttribute("data-tried", "PNG");
      qrImg.src = qrPNG;
    } else {
      showQrError(`${qrPng} puis ${qrPNG}`);
    }
  };
  qrImg.src = qrPng;

  // Lien tÃ©lÃ©phone
  const base = location.href.replace(/\/[^\/]*$/, "/");
  badgeUrl.textContent = `QR â†’ question.html?vote=${voteKey}`;

  // Question / choix
  const poll = POLLS[voteKey] || null;
  if (poll) {
    qTitle.textContent = poll.question;
    qChoices.innerHTML = "";
    poll.choices.forEach(txt => {
      const li = document.createElement("li");
      li.textContent = txt;
      qChoices.appendChild(li);
    });
  } else {
    qTitle.textContent = `Question introuvable pour ${voteKey}`;
    qChoices.innerHTML = "";
  }

  // Timer
  let timerId = null;

  function stopTimer(){
    if (timerId) clearInterval(timerId);
    timerId = null;
  }

  function endVote(){
    status.textContent = "Vote terminÃ©";
    status.style.borderColor = "rgba(255,107,107,.55)";
    overlay.style.display = "flex";
    setTimeout(() => {
      location.href = `resultats.html?vote=${encodeURIComponent(voteKey)}`;
    }, 900);
  }

  function startTimer(){
    stopTimer();
    status.textContent = "Vote ouvert";
    status.style.borderColor = "rgba(76,175,80,.55)";
    bar.style.width = "0%";

    const startedAt = Date.now();

    const tick = () => {
      const elapsed = (Date.now() - startedAt) / 1000;
      const remaining = Math.max(0, Math.ceil(DURATION - elapsed));
      timeLeft.textContent = String(remaining);

      const pct = Math.min(100, Math.max(0, (elapsed / DURATION) * 100));
      bar.style.width = pct.toFixed(1) + "%";

      if (remaining <= 0) {
        stopTimer();
        endVote();
      }
    };

    tick();
    timerId = setInterval(tick, 150);
  }

  document.getElementById("btnRestart").addEventListener("click", startTimer);
  document.getElementById("btnShowResults").addEventListener("click", () => {
    location.href = `resultats.html?vote=${encodeURIComponent(voteKey)}`;
  });
  document.getElementById("btnFullscreen").addEventListener("click", async () => {
    try{
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  });

  startTimer();
</script>
</body>
</html>
